<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Categories - Trial Shift</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/category-manage.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar"></div>

  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-right">
      <i class="material-icons profile-icon" id="profileBtn">account_circle</i>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <main class="main-content">
    <h4>Manage Categories</h4>
    <div class="container">
      <!-- Add Category Form -->
      <div class="row">
        <div class="col s12">
          <div class="card">
            <div class="card-content">
              <h5>Add New Category</h5>
              <form id="addCategoryForm" class="col s12">
                <div class="row">
                  <div class="input-field col s12">
                    <input type="text" id="categoryName" name="name" required>
                    <label for="categoryName">Category Name</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s12">
                    <textarea id="categoryDescription" name="description" class="materialize-textarea"></textarea>
                    <label for="categoryDescription">Description (Optional)</label>
                  </div>
                </div>
                <div class="row">
                  <div class="col s12">
                    <button type="submit" class="btn">Add Category</button>
                  </div>
                </div>
              </form>
              <div id="addSuccess" style="display: none; color: green; text-align: center;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category List -->
      <div class="row">
        <div class="col s12">
          <div class="card">
            <div class="card-content">
              <h5>Existing Categories</h5>
              <ul class="collection" id="categoryList">
                <li class="collection-item">Loading categories...</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="/components/sidebar.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof loadSidebar === 'function') loadSidebar();

    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/';

    // Decode token
    let user;
    try {
      user = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
      console.log('Decoded user from token:', user);
      if (!user) window.location.href = '/';
    } catch (e) {
      console.error('Invalid token:', e);
      window.location.href = '/';
    }

    const addForm = document.getElementById('addCategoryForm');
    const addSuccess = document.getElementById('addSuccess');
    const categoryList = document.getElementById('categoryList');

    // Load categories
    function loadCategories() {
      fetch('/api/categories', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => {
          if (!res.ok) throw new Error('Failed to load categories');
          return res.json();
        })
        .then(categories => {
          categoryList.innerHTML = '';
          if (!categories.length) {
            categoryList.innerHTML = '<li class="collection-item">No categories found.</li>';
            return;
          }
          categories.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'collection-item';
            li.innerHTML = `
              <div>${cat.name} - ${cat.description || 'No description'}</div>
              <div class="job-actions">
                <a href="/category-edit.html?id=${cat._id}" class="btn-small">Edit</a>
                <button class="btn-small red delete-category" data-id="${cat._id}">Delete</button>
              </div>
            `;
            categoryList.appendChild(li);
          });

          // Attach delete events
          document.querySelectorAll('.delete-category').forEach(btn => {
            btn.addEventListener('click', () => {
              if (confirm('Are you sure you want to delete this category?')) {
                fetch(`/api/categories/${btn.dataset.id}`, {
                  method: 'DELETE',
                  headers: { 'Authorization': `Bearer ${token}` }
                })
                  .then(res => {
                    if (res.ok) loadCategories();
                  })
                  .catch(err => console.error('Delete error:', err));
              }
            });
          });
        })
        .catch(err => console.error('Load error:', err));
    }
    loadCategories();

    // Add category
    addForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const data = { name: addForm.name.value, description: addForm.description.value };
      fetch('/api/categories', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': `Bearer ${token}` 
        },
        body: JSON.stringify(data)
      })
        .then(res => {
          if (!res.ok) throw new Error('Failed to add category');
          addForm.reset();
          addSuccess.textContent = 'Category added successfully!';
          addSuccess.style.display = 'block';
          setTimeout(() => { addSuccess.style.display = 'none'; }, 3000);
          loadCategories();
        })
        .catch(err => console.error('Add error:', err));
    });

    // Logout and profile logic
    document.getElementById('profileBtn').addEventListener('click', () => window.location.href = '/profile.html');
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = '/';
    });
  });
</script>
</body>
</html>

